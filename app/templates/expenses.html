{% extends "base.html" %}

{% block content %}
<div class="expenses-page">
  <div class="page-header">
    <div class="header-content">
      <h1>Expenses Overview</h1>
      <p class="text-muted">Track and manage your financial transactions</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('expenses.add_transaction') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Transaction 
      </a>
    </div>
  </div>

  <div class="dashboard-summary">
    <div class="summary-card deposits">
      <div class="summary-icon">
        <i class="fas fa-arrow-down"></i>
      </div>
      <div class="summary-details">
        <span class="summary-label">Total Deposits</span>
        <span class="summary-value">฿{{ "%.2f"|format(total_deposits) }}</span>
      </div>
    </div>
    <div class="summary-card withdrawals">
      <div class="summary-icon">
        <i class="fas fa-arrow-up"></i>
      </div>
      <div class="summary-details">
        <span class="summary-label">Total Withdrawals</span>
        <span class="summary-value">฿{{ "%.2f"|format(total_withdrawals) }}</span>
      </div>
    </div>
    <div class="summary-card balance">
      <div class="summary-icon">
        <i class="fas fa-wallet"></i>
      </div>
      <div class="summary-details">
        <span class="summary-label">Current Balance</span>
        <span class="summary-value">฿{{ "%.2f"|format(current_balance) }}</span>
      </div>
    </div>
  </div>
    
  <div class="charts-section">
    <div class="chart-container">
      <div class="chart-header">
        <h3>Spending by Category</h3>
      </div>
      <canvas id="categoryChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-header">
        <h3>Daily Spending Trend</h3>
      </div>
      <canvas id="dailySpendingChart"></canvas>
    </div>
  </div>

  <div class="upload-section card">
    <div class="upload-header">
      <h3>Import Transactions (only works with krungthai pdf statement)</h3>
      <p>Upload your bank statement PDF to automatically import transactions</p>
    </div>
    <form action="{{ url_for('expenses.preview_transcript') }}" method="post" enctype="multipart/form-data" class="upload-form">
      <div class="file-input-container">
        <input type="file" name="file" id="file" accept=".pdf" required class="file-input">
        <label for="file" class="file-label">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Choose PDF file</span>
        </label>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-upload"></i>
        Upload and Extract
      </button>
    </form>
  </div>

  {% if preview_mode %}
    <div class="preview-section">
      <div class="section-header">
        <h2>Preview Transactions</h2>
        <p>Review and categorize the extracted transactions before saving</p>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Date/Time</th>
              <th>Transaction</th>
              <th>Details</th>
              <th>Deposit</th>
              <th>Withdrawal</th>
              <th>Balance</th>
              <th>Explanation</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody>
            {% for trans in parsed_transactions %}
            <tr data-transaction-id="{{ trans.id }}" data-extra="{{ trans.extra }}" data-line-text="{{ trans.line_text }}">
              <td>{{ loop.index }}</td>
              <td>{{ trans.date_time }}</td>
              <td>{{ trans.transaction_type }}</td>
              <td>{{ trans.details }}</td>
              <td class="amount deposit">{{ trans.deposit }}</td>
              <td class="amount withdrawal">{{ trans.withdrawal }}</td>
              <td class="amount">{{ trans.balance }}</td>
              <td>
                <input type="text" 
                       class="form-control" 
                       name="explanation" 
                       value="{{ trans.explanation or '' }}"
                       placeholder="Add explanation">
              </td>
              <td>
                <select class="form-control" name="category" aria-label="Select transaction category">
                  <option value="">Select Category</option>
                  {% for category in categories %}
                    <option value="{{ category.id }}" {% if trans.category == category.name or trans.category_id|string == category.id|string %}selected{% endif %}>
                      {{ category.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="actions-bar">
        <button id="confirm-upload" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Confirm and Save
        </button>
      </div>
    </div>
  {% else %}
    {% if transactions %}
      <div class="transactions-section">
        <div class="section-header">
          <h2>Transaction History</h2>
          <p>View and manage your recorded transactions</p>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Date/Time</th>
                <th>Transaction</th>
                <th>Details</th>
                <th>Deposit</th>
                <th>Withdrawal</th>
                <th>Balance</th>
                <th>Explanation</th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for trans in transactions|sort(attribute='date_time', reverse=true) %}
              <tr data-transaction-id="{{ trans.id }}" class="transaction-row">
                <td>{{ loop.index }}</td>
                <td>
                  <span class="transaction-date">
                    {{ trans.date_time.strftime('%Y-%m-%d %H:%M') if trans.date_time is not string else trans.date_time }}
                  </span>
                </td>
                <td class="transaction-type">{{ trans.transaction_type }}</td>
                <td class="transaction-details">{{ trans.details }}</td>
                <td class="amount deposit">
                  {% if trans.deposit %}
                    ฿{{ "{:,.2f}".format(trans.deposit|float) }}
                  {% endif %}
                </td>
                <td class="amount withdrawal">
                  {% if trans.withdrawal %}
                    ฿{{ "{:,.2f}".format(trans.withdrawal|float) }}
                  {% endif %}
                </td>
                <td class="amount balance">
                  ฿{{ "{:,.2f}".format(trans.balance|float) }}
                </td>
                <td>
                  <input type="text" 
                         class="form-control explanation-input" 
                         name="explanation" 
                         value="{{ trans.explanation or '' }}"
                         placeholder="Add explanation"
                         data-transaction-id="{{ trans.id }}">
                </td>
                <td>
                  <select class="form-control category-select" 
                          name="category"
                          data-transaction-id="{{ trans.id }}"
                          aria-label="Select transaction category">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if trans.category_id|string == category.id|string %}selected{% endif %}>
                      {{ category.name }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
                <td class="actions">
                  <button class="btn btn-icon btn-delete" 
                          title="Delete Transaction"
                          data-transaction-id="{{ trans.id }}">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="actions-bar">
          <button id="save-all" class="btn btn-primary">
            <i class="fas fa-save"></i>
            Save All Changes
          </button>
        </div>
      </div>
    {% endif %}

    {% if failed_transactions %}
      <div class="failed-transactions card">
        <div class="section-header">
          <h2>Failed Transactions</h2>
          <p>The following transactions could not be processed</p>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Line</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody>
              {% for failed in failed_transactions %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ failed.line }}</td>
                <td class="error-message">{{ failed.error }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if non_transactions %}
      <div class="other-lines card">
        <div class="section-header">
          <h2>Additional Information</h2>
          <p>Other content from the statement</p>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Content</th>
              </tr>
            </thead>
            <tbody>
              {% for line in non_transactions %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ line }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize charts if they exist
  if (document.getElementById('dailySpendingChart') || document.getElementById('categoryChart')) {
    initializeCharts();
  }

  // Handle confirm upload button click
  const confirmUploadBtn = document.getElementById('confirm-upload');
  if (confirmUploadBtn) {
    confirmUploadBtn.addEventListener('click', async function() {
      try {
        // Show loading state
        confirmUploadBtn.disabled = true;
        confirmUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        // Get all transaction rows
        const transactionRows = document.querySelectorAll('tr[data-transaction-id]');
        const transactions = Array.from(transactionRows).map(row => {
          try {
            // Get all the data from the row
            console.log('Processing row:', row);
            
            const transaction = {
              id: row.dataset.transactionId || '',
              date_time: row.cells[1].textContent.trim() || '',
              transaction_type: row.cells[2].textContent.trim() || '',
              details: row.cells[3].textContent.trim() || '',
              deposit: row.cells[4].textContent.trim() || '0',
              withdrawal: row.cells[5].textContent.trim() || '0',
              balance: row.cells[6].textContent.trim() || '0',
              explanation: row.querySelector('input[name="explanation"]')?.value || '',
              category_id: row.querySelector('select[name="category"]')?.value || '13',
              extra: row.dataset.extra || '',
              line_text: row.dataset['line-text'] || ''
            };

            console.log('Raw transaction data:', transaction);

            // Clean up amount fields - remove currency symbol and commas
            transaction.deposit = transaction.deposit.replace(/[฿,]/g, '') || '0';
            transaction.withdrawal = transaction.withdrawal.replace(/[฿,]/g, '') || '0';
            transaction.balance = transaction.balance.replace(/[฿,]/g, '') || '0';

            console.log('Cleaned transaction data:', transaction);
            return transaction;
          } catch (error) {
            console.error('Error processing row:', error);
            throw error;
          }
        });

        console.log('Collected transactions:', transactions);

        // Log the stringified data
        const requestData = {
          transactions: transactions
        };
        console.log('Request data:', JSON.stringify(requestData, null, 2));

        // Send data to server
        console.log('Sending request to /expenses/save_transcript');
        const response = await fetch('/expenses/save_transcript', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            transactions: transactions
          })
        });

        console.log('Server response:', response);
        const result = await response.json();
        console.log('Response data:', result);

        if (!response.ok) {
          throw new Error(result.error || 'Failed to save transactions');
        }

        // Show success message
        const container = document.querySelector('.container');
        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.textContent = `Successfully saved ${result.count} transactions.`;
        container.insertBefore(alert, container.firstChild);

        // If there are failed transactions, show them
        if (result.failed_transactions && result.failed_transactions.length > 0) {
          const failedAlert = document.createElement('div');
          failedAlert.className = 'alert alert-warning';
          failedAlert.textContent = `Failed to save ${result.failed_transactions.length} transactions.`;
          container.insertBefore(failedAlert, container.firstChild);
        }

        // Redirect to expenses page after short delay
        setTimeout(() => {
          window.location.href = '/expenses/';
        }, 2000);

      } catch (error) {
        // Show error message
        const container = document.querySelector('.container');
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.textContent = error.message || 'An error occurred while saving transactions.';
        container.insertBefore(alert, container.firstChild);

        // Reset button state
        confirmUploadBtn.disabled = false;
        confirmUploadBtn.innerHTML = '<i class="fas fa-save"></i> Confirm and Save';
      }
    });
  }
});

function initializeCharts() {
  // Destroy existing charts if they exist
  const dailyChartCanvas = document.getElementById('dailySpendingChart');
  const categoryChartCanvas = document.getElementById('categoryChart');

  if (dailyChartCanvas) {
    const existingDailyChart = Chart.getChart(dailyChartCanvas);
    if (existingDailyChart) {
      existingDailyChart.destroy();
    }
  }

  if (categoryChartCanvas) {
    const existingCategoryChart = Chart.getChart(categoryChartCanvas);
    if (existingCategoryChart) {
      existingCategoryChart.destroy();
    }
  }

  // Use the `daily_spending` and `categories` data passed from the backend
  const dailySpendingData = JSON.parse('{{ daily_spending|tojson|safe }}');
  const categoriesData = JSON.parse('{{ categories|tojson|safe }}');

  // Debug logs for data
  console.log('Daily Spending Data:', dailySpendingData);
  console.log('Categories Data:', categoriesData);

  // Process data for daily spending chart
  const dailyLabels = Object.keys(dailySpendingData);
  const dailyValues = Object.values(dailySpendingData);

  // Process data for category chart
  const categoryLabels = categoriesData.map(category => category.name);
  const categoryValues = categoriesData.map(category => category.total || 0); // Assuming `total` is passed for each category

  // Debug logs for processed data
  console.log('Category Labels:', categoryLabels);
  console.log('Category Values:', categoryValues);

  // Create daily spending line chart
  if (dailyChartCanvas) {
    new Chart(dailyChartCanvas, {
      type: 'line',
      data: {
        labels: dailyLabels,
        datasets: [{
          label: 'Daily Spending',
          data: dailyValues,
          borderColor: '#36A2EB',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Create category pie chart
  if (categoryChartCanvas) {
    new Chart(categoryChartCanvas, {
      type: 'doughnut',
      data: {
        labels: categoryLabels,
        datasets: [{
          data: categoryValues,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
            '#9966FF', '#FF9F40', '#FF6384', '#36A2EB'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              padding: 20,
              font: {
                size: 12
              }
            }
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
  }
}
</script>
{% endblock %}
