{% extends "base.html" %}

{% block title %}AI Financial Planning{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <h1>Personal AI for Financial Planning</h1>
  </div>
  
  <div class="section-header">
    <h2>Total Expenses</h2>
  </div>
  
  <div class="charts-section">
    <div class="chart-container" style="height: 400px; position: relative;">
      <div class="chart-header">
        <h3>Spending by Category</h3>
      </div>
      <canvas id="categoryChart" style="width: 100%; height: 100%;"></canvas>
    </div>
    <div class="chart-container" style="height: 400px; position: relative;">
      <div class="chart-header">
        <h3>Daily Spending Trend</h3>
      </div>
      <canvas id="dailySpendingChart" style="width: 100%; height: 100%;"></canvas>
    </div>
  </div>

  <style>
    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-header {
      margin-bottom: 15px;
      text-align: center;
    }
    .chart-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
    }
    .chart-error i {
      font-size: 24px;
      margin-bottom: 10px;
      color: #dc3545;
    }
  </style>

  <div class="form-container">
    <div class="section-header">
      <h2>Your Financial Information</h2>
    </div>
    <div class="financial-inputs-grid">
      <div class="input-group">
        <label>Monthly Income</label>
        <input 
          type="text" 
          id="earningsInput" 
          class="financial-input" 
          placeholder="Enter amount..."
          maxlength="15"
        >
      </div>
      <div class="input-group">
        <label>Monthly Expenses</label>
        <input 
          type="text" 
          id="expensesInput" 
          class="financial-input" 
          placeholder="Enter amount..."
          maxlength="15"
        >
      </div>
      <div class="input-group">
        <label>Current Debt</label>
        <input 
          type="text" 
          id="debtInput" 
          class="financial-input" 
          placeholder="Enter amount..."
          maxlength="15"
        >
      </div>
      <div class="input-group">
        <label>Savings Goal</label>
        <input 
          type="text" 
          id="savingsInput" 
          class="financial-input" 
          placeholder="Enter amount..."
          maxlength="15"
        >
      </div>
      <div class="action-buttons">
        <button id="analyzeBtn" class="analyze-button">
          <i class="fas fa-chart-line"></i>
          Analyze My Finances
        </button>
        <button id="saveBtn" class="save-button">
          <i class="fas fa-save"></i>
          Save Profile
        </button>
      </div>
    </div>
  </div>

  <div id="analysisResults" class="analysis-results" style="display:none;">
    <h3>Financial Analysis</h3>
    <div id="resultsContent"></div>
  </div>

  <div class="form-container">
    <div class="section-header">
      <h2>ที่ปรึกษาทางการเงิน AI</h2>
    </div>
    <form id="thaiAiForm" class="financial-form">
      <textarea 
        id="thaiAiQuestion" 
        class="financial-input" 
        placeholder="กรุณากรอกคำถามของคุณที่นี่..."
        required
      ></textarea>
      <button type="submit" class="save-button">
        <i class="fas fa-paper-plane"></i>
        ส่งคำถาม
      </button>
    </form>
    <div id="thaiAiResponse" class="analysis-results" style="display: none;">
      <h3>คำตอบจากที่ปรึกษา AI</h3>
      <div class="response-content"></div>
    </div>
    <div id="continueDashboard" style="display: none; text-align: center; margin-top: 20px;">
      <a href="/dashboard" class="btn btn-primary">ไปยังแดชบอร์ด</a>
    </div>
  </div>

<script>
document.getElementById('thaiAiForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const form = e.target;
  const submitButton = form.querySelector('button[type="submit"]');
  const question = document.getElementById('thaiAiQuestion').value;
  const responseDiv = document.getElementById('thaiAiResponse');
  const responseContent = responseDiv.querySelector('.response-content');
  
  // Disable button and show loading state
  submitButton.disabled = true;
  submitButton.style.backgroundColor = '#808080';
  submitButton.style.cursor = 'not-allowed';
  const originalText = submitButton.innerHTML;
  submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังประมวลผล...';
  
  // Show response div with loading message
  responseContent.innerHTML = 'กำลังประมวลผล...';
  responseDiv.style.display = 'block';
  
  fetch('/ai/thai_advisor', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      question: question
    })
  })
  .then(response => {
    if (!response.ok) {
      if (response.status === 401) {
        // Session expired
        window.location.href = '/login';
        throw new Error('กรุณาเข้าสู่ระบบใหม่');
      }
      if (response.status === 404) {
        throw new Error('ไม่พบหน้าที่ต้องการ กรุณารีเฟรชหน้าเว็บ');
      }
      throw new Error('เซิร์ฟเวอร์มีปัญหา กรุณาลองใหม่อีกครั้ง');
    }
    // Check if response is JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('เซิร์ฟเวอร์ส่งข้อมูลผิดรูปแบบ กรุณารีเฟรชหน้าเว็บ');
    }
    return response.json();
  })
  .then(data => {
    if (data.success && data.data && data.data.response) {
      responseContent.innerHTML = data.data.response.replace(/\n/g, '<br>');
      document.getElementById('continueDashboard').style.display = 'block';
    } else {
      throw new Error(data.message || 'ไม่สามารถรับข้อมูลได้ กรุณาลองใหม่อีกครั้ง');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    responseContent.innerHTML = 'เกิดข้อผิดพลาด: ' + error.message;
    // If session expired, disable form
    if (error.message === 'กรุณาเข้าสู่ระบบใหม่') {
      form.querySelector('textarea').disabled = true;
      submitButton.style.display = 'none';
    }
  })
  .finally(() => {
    // Reset button state after a delay unless redirecting
    if (responseContent.innerHTML !== 'เกิดข้อผิดพลาด: กรุณาเข้าสู่ระบบใหม่') {
      setTimeout(() => {
        submitButton.disabled = false;
        submitButton.style.backgroundColor = '';
        submitButton.style.cursor = '';
        submitButton.innerHTML = originalText;
      }, 500);
    }
  });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Prefill form fields if profile data exists
  const profileData = JSON.parse('{% if profile %}{"income":{{ profile.income|default(0)|int }},"expenses":{{ profile.expenses|default(0)|int }},"debt":{{ profile.debt|default(0)|int }},"savingsGoal":{{ profile.savings_goal|default(0)|int }}}{% else %}null{% endif %}');

  if (profileData) {
    document.getElementById('earningsInput').value = '฿' + profileData.income.toLocaleString();
    document.getElementById('expensesInput').value = '฿' + profileData.expenses.toLocaleString();
    document.getElementById('debtInput').value = '฿' + profileData.debt.toLocaleString();
    document.getElementById('savingsInput').value = '฿' + profileData.savingsGoal.toLocaleString();
  }

  // Color palette for charts
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
    '#9966FF', '#FF9F40', '#FF6384', '#36A2EB'
  ];

  // Define chart colors
  const chartColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
    '#9966FF', '#FF9F40', '#FF6384', '#36A2EB',
    '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
  ];

  // Initialize charts
  function initializeCharts() {
    console.log('Starting chart initialization...');
    
    // Wait for Chart.js to be ready
    if (typeof Chart === 'undefined') {
      console.log('Chart.js not loaded yet, waiting...');
      setTimeout(initializeCharts, 100);
      return;
    }
    
    // Get chart elements
    const categoryChartCanvas = document.getElementById('categoryChart');
    const dailyChartCanvas = document.getElementById('dailySpendingChart');
    
    if (!categoryChartCanvas || !dailyChartCanvas) {
      console.error('Chart canvas elements not found');
      return;
    }
    
    console.log('Found chart canvas elements');
    
    // Destroy existing charts if they exist
    [categoryChartCanvas, dailyChartCanvas].forEach(canvas => {
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        console.log('Destroying existing chart');
        existingChart.destroy();
      }
    });

    // Load and update chart data
    console.log('Fetching chart data...');
    fetch('/ai/analysis/overview')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load chart data');
        }
        return response.json();
      })
      .then(data => {
        console.log('Chart data loaded:', data);
        
        // Initialize category chart
        if (data.categories && Object.keys(data.categories).length > 0) {
          console.log('Creating category chart with data:', data.categories);
          const categoryLabels = Object.keys(data.categories);
          const categoryData = Object.values(data.categories);
          
          // Ensure we have enough colors
          const categoryColors = categoryLabels.map((_, i) => chartColors[i % chartColors.length]);
          
          new Chart(categoryChartCanvas, {
            type: 'doughnut',
            data: {
              labels: categoryLabels,
              datasets: [{
                data: categoryData,
                backgroundColor: categoryColors,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                padding: {
                  left: 10,
                  right: 120,  // Extra padding for legend
                  top: 10,
                  bottom: 10
                }
              },
              plugins: {
                legend: {
                  position: 'right',
                  align: 'center',
                  labels: {
                    padding: 20,
                    font: {
                      size: 12
                    },
                    generateLabels: function(chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        const dataset = data.datasets[0];
                        const total = dataset.data.reduce((a, b) => a + b, 0);
                        return data.labels.map((label, i) => {
                          const value = dataset.data[i];
                          const percentage = ((value / total) * 100).toFixed(1);
                          return {
                            text: `${label} (${percentage}%)`,
                            fillStyle: dataset.backgroundColor[i],
                            hidden: isNaN(dataset.data[i]),
                            index: i,
                            strokeStyle: '#fff',
                            lineWidth: 2
                          };
                        });
                      }
                      return [];
                    }
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const value = context.raw;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `฿${value.toLocaleString()} (${percentage}%)`;
                    }
                  }
                }
              },
              animation: {
                animateScale: true,
                animateRotate: true
              },
              cutout: '60%'  // Adjust doughnut hole size
            }
          });
        } else {
          console.warn('No category data found');
          categoryChartCanvas.parentElement.innerHTML = `
            <div class="chart-error">
              <i class="fas fa-exclamation-triangle"></i>
              <p>No category data available.</p>
            </div>
          `;
        }

        // Initialize daily spending chart
        if (data.daily_spending && Object.keys(data.daily_spending).length > 0) {
          console.log('Creating daily spending chart with data:', data.daily_spending);
          const dates = Object.keys(data.daily_spending);
          const amounts = Object.values(data.daily_spending);
          
          new Chart(dailyChartCanvas, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [{
                label: 'Daily Spending',
                data: amounts,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const value = context.raw;
                      return `฿${value.toLocaleString()}`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '฿' + value.toLocaleString();
                    }
                  }
                }
              }
            }
          });
        } else {
          console.warn('No daily spending data found');
          dailyChartCanvas.parentElement.innerHTML = `
            <div class="chart-error">
              <i class="fas fa-exclamation-triangle"></i>
              <p>No daily spending data available.</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error loading chart data:', error);
        // Show error message in chart areas
        const errorHTML = `
          <div class="chart-error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load chart data. Please try again later.</p>
          </div>
        `;
        categoryChartCanvas.parentElement.innerHTML = errorHTML;
        dailyChartCanvas.parentElement.innerHTML = errorHTML;
      });
  }

  // Initialize charts when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCharts);
  } else {
    setTimeout(initializeCharts, 100); // Give Chart.js a moment to load
  }

  // Handle currency formatting for all financial inputs
  const financialInputs = document.querySelectorAll('.financial-input');
  financialInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      let value = e.target.value.replace(/[^0-9]/g, '');
      if (value) {
        value = parseFloat(value).toLocaleString();
        e.target.value = `฿${value}`;
      }
    });
  });

  // Handle analyze button click
  document.getElementById('analyzeBtn').addEventListener('click', function(event) {
    const button = event.target;
    button.disabled = true;
    button.style.backgroundColor = 'grey';
    button.style.cursor = 'not-allowed';
    button.textContent = 'Processing...';

    const income = parseFloat(document.getElementById('earningsInput').value.replace(/[^0-9]/g, '')) || 0;
    const expenses = parseFloat(document.getElementById('expensesInput').value.replace(/[^0-9]/g, '')) || 0;
    const debt = parseFloat(document.getElementById('debtInput').value.replace(/[^0-9]/g, '')) || 0;
    const savingsGoal = parseFloat(document.getElementById('savingsInput').value.replace(/[^0-9]/g, '')) || 0;

    // Calculate financial metrics
    const disposableIncome = income - expenses;
    const savingsRate = income > 0 ? (disposableIncome / income * 100).toFixed(1) : 0;
    const debtToIncome = income > 0 ? (debt / income * 100).toFixed(1) : 0;
    const monthsToGoal = disposableIncome > 0 ? (savingsGoal / disposableIncome).toFixed(1) : '∞';

    // Display results
    const resultsHTML = `
      <div class="metric">
        <span class="label">Disposable Income:</span>
        <span class="value">฿${disposableIncome.toLocaleString()}</span>
      </div>
      <div class="metric">
        <span class="label">Savings Rate:</span>
        <span class="value">${savingsRate}%</span>
      </div>
      <div class="metric">
        <span class="label">Debt-to-Income:</span>
        <span class="value">${debtToIncome}%</span>
      </div>
      <div class="metric">
        <span class="label">Months to Savings Goal:</span>
        <span class="value">${monthsToGoal}</span>
      </div>
    `;

    document.getElementById('resultsContent').innerHTML = resultsHTML;
    document.getElementById('analysisResults').style.display = 'block';

    // Simulate processing or send request
    setTimeout(() => {
      button.disabled = false;
      button.style.backgroundColor = '';
      button.style.cursor = '';
      button.textContent = 'Analyze My Finances';
    }, 3000); // Reset after 3 seconds for demo purposes
  });

  // Handle save button click
  document.getElementById('saveBtn').addEventListener('click', function() {
    const income = parseFloat(document.getElementById('earningsInput').value.replace(/[^0-9]/g, '')) || 0;
    const expenses = parseFloat(document.getElementById('expensesInput').value.replace(/[^0-9]/g, '')) || 0;
    const debt = parseFloat(document.getElementById('debtInput').value.replace(/[^0-9]/g, '')) || 0;
    const savingsGoal = parseFloat(document.getElementById('savingsInput').value.replace(/[^0-9]/g, '')) || 0;

    fetch('/ai/save_financial_profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        income: income,
        expenses: expenses,
        debt: debt,
        savings_goal: savingsGoal
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error saving profile: ' + data.error);
      } else {
        alert('Profile saved successfully!');
      }
    })
    .catch(error => {
      alert('Error saving profile: ' + error.message);
    });
  });
});
</script>

{% endblock %}
